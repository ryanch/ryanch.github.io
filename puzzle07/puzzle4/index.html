<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../favicon.ico">

    <title>Puzzle 4: Solve This</title>

    <!-- Bootstrap core CSS -->
    <link href="../assets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
    <link href="../assets/blog.css" rel="stylesheet">
    <script src="../assets/app.js" ></script>
  </head>


  <body  onload="app.pageLoaded();">

    <div class="container">
      <header class="blog-header py-3">
        <div class="row flex-nowrap justify-content-between align-items-center">
          <div class="col-4 pt-1">
            <a class="text-muted" href="#">#puzzle-hunt</a>
          </div>
          <div class="col-4 text-center">
            <a class="blog-header-logo puzzle4_color" href="#">"Puzzle This"</a>
          </div>
          <div class="col-4 d-flex justify-content-end align-items-center">
            <a class="text-muted" href="../index.html">Home</a>
          </div>
        </div>
      </header>

      <script>app.printTopNav("../");</script>

      <div class="jumbotron p-3 p-md-5 text-white rounded bg-dark">
        <div class="col-md-6 px-0">
          <h1 class="display-4 font-italic">Puzzle 4</h1>
          <p class="lead my-3">Play full screen. not mobile fiendly, Find the channel for your answer.</p>
          <script>
            app.printPuzzleAnswerInputBlock(4);
          </script>
        </div>
      </div>




            <!-- start puzzle -->

<style>


*, *:before, *:after {
  box-sizing: border-box;
}

.starImg {

    position: absolute;
    left: 5px;
    top: 5px;
}

.tile_letter, .tile_mystery_green, .tile_mystery_blue, .tile_mystery_yellow {
    position: absolute;
    left: 5px;
    top: 5px;
    font-weight:bold;
    background-color: rgb(221, 221, 221);
    width: 20px;
    text-align: center;
    border: 1px solid gray;
}

.tile_mystery_green {
    background-color: rgb(35, 245, 35);
}

.tile_mystery_blue {
    background-color: rgb(3, 108, 255);
}

.tile_mystery_yellow {
    background-color: rgb(245, 242, 35);
}

#list {
  /*background-color: rgba(186, 42, 42, 0.2);*/
  width: 250px;
  width: 90%;
  width: 0;
  position: relative;
  display: block;
  margin-top: 50px;
}

.tile {
  display: block;
  position: absolute;
  background-color: rgb(250, 249, 249);
  /*padding: 5px;*/
  font-weight: bold;
}

.layout {
  margin-bottom: 15px;
  
  label {
    margin-right: 15px;
    cursor: pointer;
    

  }

  input {
    margin-right: 3px;
  }
}

</style>



<div id="list"></div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/utils/Draggable.min.js"></script>


<script>

// GRID OPTIONS
var rowSize   = 100;
var colSize   = 100;
var gutter    = 7;     // Spacing between tiles
var numTiles  = 40;    // Number of tiles to initially populate the grid with
var fixedSize = true; // When true, each tile's colspan will be fixed to 1
var oneColumn = false; // When true, grid will only have 1 column and tiles have fixed colspan of 1
var threshold = "50%"; // This is amount of overlap between tiles needed to detect a collision

var $add  = $("#add");
var $list = $("#list");
var $mode = $("input[name='layout']");

// Live node list of tiles
var tiles  = $list[0].getElementsByClassName("tile");
var label  = 1;
var zIndex = 1000;

var startWidth  = "100%";
var startSize   = colSize;
var singleWidth = colSize * 3;

var colCount   = null;
var rowCount   = null;
var gutterStep = null;

var shadow1 = "0 1px 3px  0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.6)";
var shadow2 = "0 6px 10px 0 rgba(0, 0, 0, 0.3), 0 2px 2px 0 rgba(0, 0, 0, 0.2)";

$(window).resize(resize);
$add.click(createTile);
$mode.change(init);

init();

// ========================================================================
//  INIT
// ========================================================================
function init() {

    var width = startWidth;

    // This value is defined when this function 
    // is fired by a radio button change event
    switch (this.value) {

        case "mixed":
            fixedSize = false;
            oneColumn = false;
            colSize   = startSize;
            break;

        case "fixed":
            fixedSize = true;
            oneColumn = false;
            colSize   = startSize;
            break;

        case "column":
            fixedSize = false;
            oneColumn = true;
            width     = singleWidth;
            colSize   = singleWidth;
            break;
    }

    // For images demo
    //window.stop();

    $(".tile").each(function() {
        Draggable.get(this).kill();
        $(this).remove();
    });

    TweenLite.to($list, 0.2, { width: width });
    TweenLite.delayedCall(0.25, populateBoard);

    function populateBoard() {

        label = 1;
        resize();

        for (var i = 0; i < numTiles; i++) {
            createTile();
        }
    }
}


// ========================================================================
//  RESIZE
// ========================================================================
function resize() {

    colCount   = oneColumn ? 1 : Math.floor($list.outerWidth() / (colSize + gutter));
    gutterStep = colCount == 1 ? gutter : (gutter * (colCount - 1) / colCount);
    rowCount   = 0;

    layoutInvalidated();
}


// ========================================================================
//  CHANGE POSITION
// ========================================================================
function changePosition(from, to, rowToUpdate) {

    var $tiles = $(".tile");
    var insert = from > to ? "insertBefore" : "insertAfter";

    // Change DOM positions
    $tiles.eq(from)[insert]($tiles.eq(to));

    layoutInvalidated(rowToUpdate);
}

// ========================================================================
//  CREATE TILE
// ========================================================================
function createTile() {


    var pipes = [
        {
            empty:  "assets/pieces/1_2.png",
            filled: "assets/pieces/1_2_w.png",
            conns: {E:true, N:true}
        },
        {
            empty:  "assets/pieces/2_3.png",
            filled: "assets/pieces/2_3_w.png",
            conns: {N:true, W:true}
        },
        {
            empty:  "assets/pieces/3_4.png",
            filled: "assets/pieces/3_4_w.png",
            conns: {W:true, S:true}
        },
        {
            empty:  "assets/pieces/1_3.png",
            filled: "assets/pieces/1_3_w.png",
            conns: {E:true, W:true}
        },
        {
            empty:  "assets/pieces/1_4.png",
            filled: "assets/pieces/1_4_w.png",
            conns: {E:true, S:true}
        },
        {
            empty:  "assets/pieces/2_4.png",
            filled: "assets/pieces/2_4_w.png",
            conns: {N:true, S:true}
        },
        {
            empty:  "assets/pieces/x.png",
            filled: "assets/pieces/x_w.png",
            conns: {E:true, N: true, W:true, S:true}
        },
    ];

    var pipe = pipes[ label % pipes.length];
    var pipeName = pipe.empty;
    label++;

    var colspan = fixedSize || oneColumn ? 1 : Math.floor(Math.random() * 2) + 1;
    //var element = $('<div></div>').addClass("tile").html(label++ );
    var element = $('<div></div>').addClass("tile").html( '<img src="'+pipeName+'" width="100" height="100" >' );

    var lastX   = 0;

    Draggable.create(element, {
        onDrag      : onDrag,
        onPress     : onPress,
        onRelease   : onRelease,
        zIndexBoost : false
    });
    
    // NOTE: Leave rowspan set to 1 because this demo 
    // doesn't calculate different row heights
    var tile = {
        col        : null,
        colspan    : colspan,
        height     : 0,
        inBounds   : true,
        index      : null,
        isDragging : false,
        lastIndex  : null,
        newTile    : true,
        positioned : false,
        row        : null,
        rowspan    : 1, 
        width      : 0,
        x          : 0,
        y          : 0,
        pipeData: pipe,
        tileElement: null
    };

    // Add tile properties to our element for quick lookup
    element[0].tile = tile;
    tile.tileElement = element;

    $list.append(element);
    layoutInvalidated();

    function onPress() {

        lastX = this.x;
        tile.isDragging = true;
        tile.lastIndex  = tile.index;

        TweenLite.to(element, 0.2, {
            autoAlpha : 0.75,
            boxShadow : shadow2,
            scale     : 0.95,
            zIndex    : "+=1000"
        });
    }

    function onDrag() {

        // Move to end of list if not in bounds
        if (!this.hitTest($list, 0)) {
            tile.inBounds = false;
            changePosition(tile.index, tiles.length - 1);
            return;
        }

        tile.inBounds = true;

        for (var i = 0; i < tiles.length; i++) {

            // Row to update is used for a partial layout update
            // Shift left/right checks if the tile is being dragged 
            // towards the the tile it is testing
            var testTile    = tiles[i].tile;
            var onSameRow   = (tile.row === testTile.row);
            var rowToUpdate = onSameRow ? tile.row : -1;
            var shiftLeft   = onSameRow ? (this.x < lastX && tile.index > i) : true;
            var shiftRight  = onSameRow ? (this.x > lastX && tile.index < i) : true;
            var validMove   = (testTile.positioned && (shiftLeft || shiftRight));

            if (this.hitTest(tiles[i], threshold) && validMove) {
                changePosition(tile.index, i, rowToUpdate);
                break;
            }
        }

        lastX = this.x;
    }

    function onRelease() {

        // Move tile back to last position if released out of bounds
        this.hitTest($list, 0)
            ? layoutInvalidated()
        : changePosition(tile.index, tile.lastIndex);

        TweenLite.to(element, 0.2, {
            autoAlpha : 1,
            boxShadow: shadow1,
            scale     : 1,
            x         : tile.x,
            y         : tile.y,
            zIndex    : ++zIndex
        });

        tile.isDragging = false;
    }
}

function walkWater(tile, tile_lookup) {

    // try to flow in other directions
    // North
    var conns = tile.pipeData.conns;
    if (conns.N) {
        var key = (tile.row-1) + "-" + tile.col;
        var otherTileWrapper = tile_lookup[key];
        if (otherTileWrapper && otherTileWrapper.wet === false) {
            otherTile = otherTileWrapper.tile;
            if (otherTile.pipeData.conns.S  ) {
                tile_lookup[key].wet = true;
                walkWater(otherTile,tile_lookup);
            }
        }
    }

    if (conns.S) {
        var key = (tile.row+1) + "-" + tile.col;
        var otherTileWrapper = tile_lookup[key];
        if (otherTileWrapper && otherTileWrapper.wet == false) {
            otherTile = otherTileWrapper.tile;
            if (otherTile.pipeData.conns.N ) {
                tile_lookup[key].wet = true;
                walkWater(otherTile,tile_lookup);
            }
        }
    }

    if (conns.E) {
        var key = (tile.row) + "-" + (tile.col-1);
        var otherTileWrapper = tile_lookup[key];
        if (otherTileWrapper && otherTileWrapper.wet == false) {
            otherTile = otherTileWrapper.tile;
            if (otherTile.pipeData.conns.W ) {
                tile_lookup[key].wet = true;
                walkWater(otherTile,tile_lookup);
            }
        }
    }

    if (conns.W) {
        var key = (tile.row) + "-" + (tile.col+1);
        var otherTileWrapper = tile_lookup[key];
        if (otherTileWrapper && otherTileWrapper.wet === false) {
            otherTile = otherTileWrapper.tile;
            if (otherTile.pipeData.conns.E  ) {
                tile_lookup[key].wet = true;
                walkWater(otherTile,tile_lookup);
            }
        }
    }


}

function flowWater() {

    var tile_lookup = {};

    $(".tile").each(function(index, element) {

        var tile  = this.tile;
        tile_lookup[ tile.row + "-" + tile.col ] = {
            tile: tile,
            wet: false
        };


    }).promise().done( function() {


        var root = tile_lookup["0-0"];
        if (root && root.tile) {
            root.wet = true;
            walkWater(root.tile, tile_lookup);
        }

        var blueStarIsWet = ( tile_lookup[ "0-9" ] && tile_lookup[ "0-9"].wet );
        var yellowStarIsWet = ( tile_lookup[ "3-0" ] && tile_lookup[ "3-0"].wet );

        // set the images
        $(".tile").each(function(index, element) {

            var tile  = this.tile;

            var starHTML = "";

            if (tile.row == 0 && tile.col == 9) {
                starHTML = '<img class="starImg" src="assets/blue-star.png" width="30" >';
            }
            else if (tile.row == 3 && tile.col == 0) {
                starHTML = '<img class="starImg" src="assets/yellow-star.png" width="30" >';
            }



            if ( tile_lookup[ tile.row + "-" + tile.col ] && tile_lookup[ tile.row + "-" + tile.col ].wet  ) {
                var letter = starting[tile.row + "-" + tile.col];
                var letterHTML = "";
                if (!letter) {
                    letterHTML = "";
                }
                else {

                    var letterColor = letter_color[tile.row + "-" + tile.col];
                    if (letterColor == "blue" && blueStarIsWet) { 
                        letterHTML = '<span class="tile_letter" >'+letter+'</span>';
                    }
                    else if (letterColor == "yellow" && yellowStarIsWet) { 
                        letterHTML = '<span class="tile_letter" >'+letter+'</span>';
                    }
                    else if (letterColor == "green" && yellowStarIsWet && blueStarIsWet) { 
                        letterHTML = '<span class="tile_letter" >'+letter+'</span>';
                    }
                    else {
                        letterHTML = '<span class="tile_mystery_'+letterColor+'" >?</span>';
                    }

                    
                }
                tile.tileElement.html('<img src="'+tile.pipeData.filled+'" width="100" height="100" >' + letterHTML + starHTML);
            }
            else {
                tile.tileElement.html('<img src="'+tile.pipeData.empty+'" width="100" height="100" >' + starHTML);
            }

        });

    });


}

// ========================================================================
//  LAYOUT INVALIDATED
// ========================================================================
function layoutInvalidated(rowToUpdate) {

    var timeline = new TimelineMax();
    var partialLayout = (rowToUpdate > -1);

    var height = 0;
    var col    = 0;
    var row    = 0;
    var time   = 0.35;

    $(".tile").each(function(index, element) {

    

        var tile    = this.tile;
        var oldRow  = tile.row;
        var oldCol  = tile.col;
        var newTile = tile.newTile;


        // PARTIAL LAYOUT: This condition can only occur while a tile is being 
        // dragged. The purpose of this is to only swap positions within a row, 
        // which will prevent a tile from jumping to another row if a space
        // is available. Without this, a large tile in column 0 may appear 
        // to be stuck if hit by a smaller tile, and if there is space in the 
        // row above for the smaller tile. When the user stops dragging the 
        // tile, a full layout update will happen, allowing tiles to move to
        // available spaces in rows above them.
        if (partialLayout) {
            row = tile.row;
            if (tile.row !== rowToUpdate) return;
        }

        // Update trackers when colCount is exceeded 
        if (col + tile.colspan > colCount) {
            col = 0; row++;
        }

        $.extend(tile, {
            col    : col,
            row    : row,
            index  : index,
            x      : col * gutterStep + (col * colSize),
            y      : row * gutterStep + (row * rowSize),
            width  : tile.colspan * colSize + ((tile.colspan - 1) * gutterStep),
            height : tile.rowspan * rowSize
        });

        col += tile.colspan;

        // If the tile being dragged is in bounds, set a new
        // last index in case it goes out of bounds
        if (tile.isDragging && tile.inBounds) {
            tile.lastIndex = index;
        }

        if (newTile) {

            // Clear the new tile flag
            tile.newTile = false;

            var from = {
                autoAlpha : 0,
                boxShadow : shadow1,
                height    : tile.height,
                scale     : 0,
                width     : tile.width
            };

            var to = {
                autoAlpha : 1,
                scale     : 1,
                zIndex    : zIndex
            }

            timeline.fromTo(element, time, from, to, "reflow");
        }

        // Don't animate the tile that is being dragged and
        // only animate the tiles that have changes
        if (!tile.isDragging && (oldRow !== tile.row || oldCol !== tile.col)) {

            var duration = newTile ? 0 : time;

            // Boost the z-index for tiles that will travel over 
            // another tile due to a row change
            if (oldRow !== tile.row) {
                timeline.set(element, { zIndex: ++zIndex }, "reflow");
            }

            timeline.to(element, duration, {
                x : tile.x,
                y : tile.y,
                onComplete : function() { tile.positioned = true; },
                onStart    : function() { tile.positioned = false; }
            }, "reflow");
        }
    });

    if (!row) rowCount = 1;

    // If the row count has changed, change the height of the container
    if (row !== rowCount) {
        rowCount = row;
        height   = rowCount * gutterStep + (++row * rowSize);
        timeline.to($list, 0.2, { height: height }, "reflow");
    }

    flowWater();
}

var letter_color = {};
letter_color["0-5"] = "blue";
letter_color["0-6"] = "blue";
letter_color["0-7"] = "blue";
letter_color["0-8"] = "blue";
letter_color["0-3"] = "blue";
 letter_color["0-4"] = "blue";
letter_color["1-5"] = "yellow";
letter_color["1-6"] = "yellow";
letter_color["2-2"] = "green";
letter_color["2-3"] = "green";
letter_color["2-4"] = "green";
letter_color["2-5"] = "green";
letter_color["2-6"] = "green";
letter_color["2-7"] = "green";

var starting = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-5"] = "P";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-2"] = "P";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-5"] = "S";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-6"] = "W";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-8"] = "R";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["1-5"] = "I";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["1-6"] = "S";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-4"] = "N";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-3"] = "A";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-3"] = "U";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-4"] = "R";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-6"] = "L";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["2-7"] = "E";
                                                                                                                                                                                                                                                                                                                                                                                                                                            starting["0-7"] = "E";


</script>



    </div>



  </body>
</html>

